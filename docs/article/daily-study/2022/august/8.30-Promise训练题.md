# 8.30-Promise è®­ç»ƒé¢˜

## æè¿°

Promise åŸºç¡€é¢˜(ç”±æµ…å…¥æ·±)

## Promise

**é¢˜ç›®ä¸€**

```js
const promise = new Promise((resolve, reject) => {
  console.log(1)
  resolve('success')
  console.log(2)
})
promise.then(() => {
  console.log(3)
})
console.log(4)
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>1</div>
  <div>2</div>
  <div>4</div>
  <div>3</div>
</details>

**é¢˜ç›®äºŒ**

```js
const promise = new Promise((resolve, reject) => {
  console.log(1)
  console.log(2)
})
promise.then(() => {
  console.log(3)
})
console.log(4)
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>1</div>
  <div>2</div>
  <div>4</div>
</details>

**é¢˜ç›®ä¸‰**

```js
Â const promise1 = new Promise((resolve, reject) => {
Â  Â console.log('promise1')
Â  Â resolve('resolve1')
Â })
Â const promise2 = promise1.then(res => {
Â  Â console.log(res)
Â })
Â console.log('1', promise1);
Â console.log('2', promise2);

Â // ç­”æ¡ˆ
Â 'promise1'
Â '1' Promise{<resolved>: 'resolve1'}
Â '2' Promise{<pending>}
Â 'resolve1'
```

**é¢˜ç›®å››**

```js
const fn = () => (new Promise((resolve, reject) => {
Â  Â console.log(1);
Â  Â resolve('success')
Â }))
Â fn().then(res => {
Â  Â console.log(res)
Â })
Â console.log('start')
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>1</div>
  <div>start</div>
  <div>success</div>
</details>

## Promise +setTimeout

**é¢˜ç›®ä¸€**

```js
console.log('start')
setTimeout(() => {
  console.log('time')
})
Promise.resolve().then(() => {
  console.log('resolve')
})
console.log('end')
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>start</div>
  <div>end</div>
  <div>resolve</div>
  <div>time</div>
</details>

**é¢˜ç›®äºŒ**

```js
const promise = new Promise((resolve, reject) => {
  console.log(1)
  setTimeout(() => {
    console.log('timerStart')
    resolve('success')
    console.log('timerEnd')
  }, 0)
  console.log(2)
})
promise.then(res => {
  console.log(res)
})
console.log(4)
```

<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>1</div>
  <div>2</div>
  <div>4</div>
  <div>timerStart</div>
  <div>timerEnd</div>
  <div>success</div>
</details>

**é¢˜ç›®ä¸‰**

```js
setTimeout(() => {
  console.log('timer1')
  Promise.resolve().then(() => {
    console.log('promise')
  })
}, 0)
setTimeout(() => {
  console.log('timer2')
}, 0)
console.log('start')
```

<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>start</div>
  <div>timer1</div>
  <div>promise</div>
  <div>timer2</div>
</details>

**é¢˜ç›®å››**

```js
Â const promise1 = new Promise((resolve, reject) => {
Â  Â setTimeout(() => {
Â  Â  Â resolve('success')
Â   }, 1000)
Â })
Â const promise2 = promise1.then(() => {
Â  Â throw new Error('error!!!')
Â })
Â console.log('promise1', promise1)
Â console.log('promise2', promise2)
Â setTimeout(() => {
Â  Â console.log('promise1', promise1)
Â  Â console.log('promise2', promise2)
Â }, 2000)
Â // ç­”æ¡ˆ
Â 'promise1': promise{<pedding>}
Â 'promise2': promise{<pedding>}
Â 'promise1': promise{<resolve>:'success'}
Â 'promise2': promise{<rejected>:Error: error!!!}
```



## Promise ä¸­çš„ thenã€catchã€finally

`çŸ¥è¯†è¡¥å……`

- Promise çš„çŠ¶æ€ä¸€ç»æ”¹å˜å°±ä¸èƒ½å†æ”¹å˜ã€‚(è§é¢˜ 1)

- .then å’Œ.catch éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promiseã€‚
- catch ä¸ç®¡è¢«è¿æ¥åˆ°å“ªé‡Œï¼Œéƒ½èƒ½æ•è·ä¸Šå±‚æœªæ•æ‰è¿‡çš„é”™è¯¯ã€‚(è§é¢˜ 2)
- åœ¨ Promise ä¸­ï¼Œè¿”å›ä»»æ„ä¸€ä¸ªé promise çš„å€¼éƒ½ä¼šè¢«åŒ…è£¹æˆ promise å¯¹è±¡ï¼Œä¾‹å¦‚ return 2 ä¼šè¢«åŒ…è£…ä¸º return Promise.resolve(2)ã€‚
- Promise çš„ .then æˆ–è€… .catch å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡, ä½†å¦‚æœ Promise å†…éƒ¨çš„çŠ¶æ€ä¸€ç»æ”¹å˜ï¼Œå¹¶ä¸”æœ‰äº†ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆåç»­æ¯æ¬¡è°ƒç”¨.then æˆ–è€….catch çš„æ—¶å€™éƒ½ä¼šç›´æ¥æ‹¿åˆ°è¯¥å€¼ã€‚(è§é¢˜ 5)
- .then æˆ–è€… .catch ä¸­ return ä¸€ä¸ª error å¯¹è±¡å¹¶ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œæ‰€ä»¥ä¸ä¼šè¢«åç»­çš„ .catch æ•è·ã€‚(è§é¢˜ 6)
- .then æˆ– .catch è¿”å›çš„å€¼ä¸èƒ½æ˜¯ promise æœ¬èº«ï¼Œå¦åˆ™ä¼šé€ æˆæ­»å¾ªç¯ã€‚(è§é¢˜ 6)
- .then æˆ–è€… .catch çš„å‚æ•°æœŸæœ›æ˜¯å‡½æ•°ï¼Œä¼ å…¥éå‡½æ•°åˆ™ä¼šå‘ç”Ÿ**å€¼é€ä¼ **ã€‚(è§é¢˜ 7)
- .then æ–¹æ³•æ˜¯èƒ½æ¥æ”¶ä¸¤ä¸ªå‚æ•°çš„ï¼Œç¬¬ä¸€ä¸ªæ˜¯å¤„ç†æˆåŠŸçš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªæ˜¯å¤„ç†å¤±è´¥çš„å‡½æ•°ï¼Œå†æŸäº›æ—¶å€™ä½ å¯ä»¥è®¤ä¸º catch æ˜¯.then ç¬¬äºŒä¸ªå‚æ•°çš„ç®€ä¾¿å†™æ³•ã€‚
- .finally æ–¹æ³•ä¹Ÿæ˜¯è¿”å›ä¸€ä¸ª Promiseï¼Œä»–åœ¨ Promise ç»“æŸçš„æ—¶å€™ï¼Œæ— è®ºç»“æœä¸º resolved è¿˜æ˜¯ rejectedï¼Œéƒ½ä¼šæ‰§è¡Œé‡Œé¢çš„å›è°ƒå‡½æ•°

**é¢˜ç›®ä¸€**

```js
const promise = new Promise((resolve, reject) => {
  resolve('success1')
  reject('error')
  resolve('success2')
})
promise
  .then(res => {
    console.log('then: ', res)
  })
  .catch(err => {
    console.log('catch: ', err)
  })
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>"then: success1"</div>
</details>

**é¢˜ç›®äºŒ**

```js
const promise = new Promise((resolve, reject) => {
Â  Â reject("error");
Â  Â resolve("success2");
Â });
Â promise
Â .then(res => {
Â  Â  Â console.log("then1: ", res);
Â   }).then(res => {
Â  Â  Â console.log("then2: ", res);
Â   }).catch(err => {
Â  Â  Â console.log("catch: ", err);
Â   }).then(res => {
Â  Â  Â console.log("then3: ", res);
Â   })
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>"catch: " "error"</div>
  <div>"then3: " undefined</div>
  <br />
  <div style="color:#c7254e">
  éªŒè¯äº†ç¬¬ä¸‰ä¸ªç»“è®ºï¼Œcatchä¸ç®¡è¢«è¿æ¥åˆ°å“ªé‡Œï¼Œéƒ½èƒ½æ•è·ä¸Šå±‚æœªæ•æ‰è¿‡çš„é”™è¯¯<br />
  è‡³äºthen3ä¹Ÿä¼šè¢«æ‰§è¡Œï¼Œé‚£æ˜¯å› ä¸ºcatch()ä¹Ÿä¼šè¿”å›ä¸€ä¸ªPromiseï¼Œä¸”ç”±äºè¿™ä¸ªPromiseæ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥æ‰“å°å‡ºæ¥çš„æ˜¯undefined
  </div>
</details>

**é¢˜ç›®ä¸‰**

```js
Promise.resolve(1)
Â   .then(res => {
Â  Â  Â console.log(res);
Â  Â  Â return 2;
Â   })
Â   .catch(err => {
Â  Â  Â return 3;
Â   })
Â   .then(res => {
Â  Â  Â console.log(res);
Â   });
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>1</div>
  <div>2</div>
  <br />
  <div style="color:#c7254e">
  Promiseå¯ä»¥é“¾å¼è°ƒç”¨ï¼Œä¸è¿‡promise æ¯æ¬¡è°ƒç”¨ .then æˆ–è€… .catch éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ promiseï¼Œä»è€Œå®ç°äº†é“¾å¼è°ƒç”¨, å®ƒå¹¶ä¸åƒä¸€èˆ¬æˆ‘ä»¬ä»»åŠ¡çš„é“¾å¼è°ƒç”¨ä¸€æ ·return Promise
  <br />
  ä¸Šé¢çš„è¾“å‡ºç»“æœä¹‹æ‰€ä»¥ä¾æ¬¡æ‰“å°å‡º1å’Œ2ï¼Œé‚£æ˜¯å› ä¸ºresolve(1)ä¹‹åèµ°çš„æ˜¯ç¬¬ä¸€ä¸ªthenæ–¹æ³•ï¼Œå¹¶æ²¡æœ‰èµ°catché‡Œï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªthenä¸­çš„reså¾—åˆ°çš„å®é™…ä¸Šæ˜¯ç¬¬ä¸€ä¸ªthençš„è¿”å›å€¼ã€‚
Â  ä¸”return 2ä¼šè¢«åŒ…è£…æˆresolve(2)
  </div>
</details>

**é¢˜ç›®å››**

```js
Promise.reject(1)
Â   .then(res => {
Â  Â  Â console.log(res);
Â  Â  Â return 2;
Â   })
Â   .catch(err => {
Â  Â  Â console.log(err);
Â  Â  Â return 3
Â   })
Â   .then(res => {
Â  Â  Â console.log(res);
Â   });
Â 
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>1</div>
  <div>3</div>
  <br />
  <div style="color:#c7254e">å› ä¸ºreject(1)æ­¤æ—¶èµ°çš„å°±æ˜¯catchï¼Œä¸”ç¬¬äºŒä¸ªthenä¸­çš„reså¾—åˆ°çš„å°±æ˜¯catchä¸­çš„è¿”å›å€¼</div>
</details>

**é¢˜ç›®äº”**

```js
const promise = new Promise((resolve, reject) => {
Â  Â setTimeout(() => {
Â  Â  Â console.log('timer')
Â  Â  Â resolve('success')
Â   }, 1000)
Â })
Â const start = Date.now();
Â promise.then(res => {
Â  Â console.log(res, Date.now() - start)
Â })
Â promise.then(res => {
Â  Â console.log(res, Date.now() - start)
Â })
Â /*
Â å½“ç„¶ï¼Œå¦‚æœä½ è¶³å¤Ÿå¿«çš„è¯ï¼Œä¹Ÿå¯èƒ½ä¸¤ä¸ªéƒ½æ˜¯1001ã€‚
Â Promise çš„ .then æˆ–è€… .catch å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡ï¼Œä½†è¿™é‡Œ Promise æ„é€ å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡ã€‚æˆ–è€…è¯´ promise å†…éƒ¨çŠ¶æ€ä¸€ç»æ”¹å˜ï¼Œå¹¶ä¸”æœ‰äº†ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆåç»­æ¯æ¬¡è°ƒç”¨ .then æˆ–è€… .catch éƒ½ä¼šç›´æ¥æ‹¿åˆ°è¯¥å€¼ã€‚
Â */
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>timer</div>
  <div>Â 'success' 1001</div>
  <div>Â 'success' 1002</div>
</details>

**é¢˜ç›®å…­**

```js
Â Promise.resolve().then(() => {
Â  Â return new Error('error!!!')
Â }).then(res => {
Â  Â console.log("then: ", res)
Â }).catch(err => {
Â  Â console.log("catch: ", err)
Â })
Â 
Â /*
Â è¿™ä¹ŸéªŒè¯äº†ç¬¬4ç‚¹å’Œç¬¬6ç‚¹ï¼Œè¿”å›ä»»æ„ä¸€ä¸ªé promise çš„å€¼éƒ½ä¼šè¢«åŒ…è£¹æˆ promise å¯¹è±¡ï¼Œå› æ­¤è¿™é‡Œçš„return new Error('error!!!')ä¹Ÿè¢«åŒ…è£¹æˆäº†return Promise.resolve(new Error('error!!!'))ã€‚
Â 
Â å½“ç„¶å¦‚æœä½ æŠ›å‡ºä¸€ä¸ªé”™è¯¯çš„è¯ï¼Œå¯ä»¥ç”¨ä¸‹é¢ğŸ‘‡ä¸¤çš„ä»»æ„ä¸€ç§ï¼š
Â */
Â return Promise.reject(new Error('error!!!'));
Â // or
Â throw new Error('error!!!')
```

<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>'then' : "Error: error!!!"</div>
</details>

**é¢˜ç›®ä¸ƒ**

```js
Promise.resolve(1).then(2).then(Promise.resolve(3)).then(console.log) //ç­”æ¡ˆ
1 /*
Â å…¶å®ä½ åªè¦è®°ä½åŸåˆ™8ï¼š.then æˆ–è€… .catch çš„å‚æ•°æœŸæœ›æ˜¯å‡½æ•°ï¼Œä¼ å…¥éå‡½æ•°åˆ™ä¼šå‘ç”Ÿå€¼é€ä¼ ã€‚
Â ç¬¬ä¸€ä¸ªthenå’Œç¬¬äºŒä¸ªthenä¸­ä¼ å…¥çš„éƒ½ä¸æ˜¯å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯æ•°å­—ç±»å‹ï¼Œä¸€ä¸ªæ˜¯å¯¹è±¡ç±»å‹ï¼Œå› æ­¤å‘ç”Ÿäº†é€ä¼ ï¼Œå°†resolve(1) çš„å€¼ç›´æ¥ä¼ åˆ°æœ€åä¸€ä¸ªthené‡Œã€‚
Â */
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>1</div>
  <br />
  <div style="color:#c7254e">
  è®°ä½åŸåˆ™ï¼š.then æˆ–è€… .catch çš„å‚æ•°æœŸæœ›æ˜¯å‡½æ•°ï¼Œä¼ å…¥éå‡½æ•°åˆ™ä¼šå‘ç”Ÿå€¼é€ä¼ <br />
  ç¬¬ä¸€ä¸ªthenå’Œç¬¬äºŒä¸ªthenä¸­ä¼ å…¥çš„éƒ½ä¸æ˜¯å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯æ•°å­—ç±»å‹ï¼Œä¸€ä¸ªæ˜¯å¯¹è±¡ç±»å‹ï¼Œå› æ­¤å‘ç”Ÿäº†é€ä¼ ï¼Œå°†resolve(1) çš„å€¼ç›´æ¥ä¼ åˆ°æœ€åä¸€ä¸ªthené‡Œ
  </div>
</details>

## async/await çš„å‡ é“é¢˜

**é¢˜ç›®ä¸€**

```js
async function async1() {
  console.log('async1 start')
  await async2()
  console.log('async1 end')
}
async function async2() {
  console.log('async2')
}
async1()
console.log('start') //ç­”æ¡ˆ
```

å°†ä¸Šè¿° async awiat è½¬ä¸º promise.then

```js
async function async1() {
  console.log('async1 start') // åŸæ¥ä»£ç  // await async2(); // console.log("async1 end"); // è½¬æ¢åä»£ç 
  new Promise(resolve => {
    console.log('async2')
    resolve()
  }).then(res => console.log('async1 end'))
}
async function async2() {
  console.log('async2')
}
async1()
console.log('start')
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>async1 start</div>
  <div>async2</div>
  <div>start</div>
  <div>async1 end</div>
</details>

**é¢˜ç›®äºŒ**

```js
async function async1() {
Â  Â console.log("async1 start");
Â  Â await async2();
Â  Â console.log("async1 end");
Â }
Â async function async2() {
Â  Â setTimeout(() => {
Â  Â  Â console.log('timer')
Â   }, 0)
Â  Â console.log("async2");
Â }
Â async1();
Â console.log("start")
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>async1 start</div>
  <div>async2</div>
  <div>start</div>
  <div>async1 end</div>
  <div>timer</div>
  <br />
  <div style="color:#c7254e">tip: å®šæ—¶å™¨å§‹ç»ˆè¿˜æ˜¯æœ€åæ‰§è¡Œçš„ï¼Œå®ƒè¢«æ”¾åˆ°ä¸‹ä¸€æ¡å®ä»»åŠ¡çš„å»¶è¿Ÿé˜Ÿåˆ—ä¸­ã€‚</div>
</details>

**é¢˜ç›®ä¸‰**

```js
async function async1() {
Â  Â console.log("async1 start");
Â  Â await async2();
Â  Â console.log("async1 end");
Â  Â setTimeout(() => {
Â  Â  Â console.log('timer1') // 3
Â   }, 0)
Â }
Â async function async2() {
Â  Â setTimeout(() => {
Â  Â  Â console.log('timer2') Â // 1
Â   }, 0)
Â  Â console.log("async2");
Â }
Â async1();
Â setTimeout(() => {
Â  Â console.log('timer3') Â // 2
Â }, 0)
Â console.log("start")
```
<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>async1 start</div>
  <div>start</div>
  <div>async1 end</div>
  <div>timer2</div>
  <div>timer3</div>
  <div>timer1</div>
  <br />
  <div style="color:#c7254e">tip: å®šæ—¶å™¨è°å…ˆæ‰§è¡Œï¼Œä½ åªéœ€è¦å…³æ³¨è°å…ˆè¢«è°ƒç”¨çš„ä»¥åŠå»¶è¿Ÿæ—¶é—´æ˜¯å¤šå°‘ï¼Œè¿™é“é¢˜ä¸­å»¶è¿Ÿæ—¶é—´éƒ½æ˜¯0ï¼Œæ‰€ä»¥åªè¦å…³æ³¨è°å…ˆè¢«è°ƒç”¨çš„ã€‚</div>
</details>

## async å¤„ç†é”™è¯¯

**é¢˜ç›®ä¸€**

```js
async function async1 () {
Â  Â await async2();
Â  Â console.log('async1');
Â  Â return 'async1 success'
Â }
Â async function async2 () {
Â  Â return new Promise((resolve, reject) => {
Â  Â  Â console.log('async2')
Â  Â  Â reject('error')
Â   })
Â }
Â async1().then(res => console.log(res))
```

<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>async2</div>
  <div>Uncaught (in promise) error</div>
  <br />
  <div style="color:#c7254e">tip: å¦‚æœåœ¨asyncå‡½æ•°ä¸­æŠ›å‡ºäº†é”™è¯¯ï¼Œåˆ™ç»ˆæ­¢é”™è¯¯ç»“æœï¼Œä¸ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚</div>
</details>

**é¢˜ç›®äºŒ**

```js
//å¦‚æœæƒ³è¦ä½¿å¾—é”™è¯¯çš„åœ°æ–¹ä¸å½±å“asyncå‡½æ•°åç»­çš„æ‰§è¡Œçš„è¯ï¼Œå¯ä»¥ä½¿ç”¨try catch
async function async1() {
  try {
    await Promise.reject('error!!!')
  } catch (e) {
    console.log(e)
  }
  console.log('async1')
  return Promise.resolve('async1 success')
}
async1().then(res => console.log(res))
console.log('script start')
```

<details>
  <summary>ç­”æ¡ˆ</summary>
  <div>script start</div>
  <div>error!!!</div>
  <div>async1</div>
  <div>async1 success</div>
</details>
