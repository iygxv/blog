# 9.13-学习http(九)

## **HTTP的重定向和跳转** 

### **描述**

由服务器发起, 浏览器使用者无法控制的这类跳转叫做`重定向`

**Location**字段属于响应字段，必须出现在响应报文里。但只有配合 301/302 状态码才有意义，它**标记了服务器要求重定向的URI**。

浏览器收到 301/302 报文，会检查响应头里有没有Location。如果有，就从字段值里提取出 URI，发出新的 HTTP 请求，相当于自动替我们点击了这个链接

在Location里的 URI 既可以使用绝对 URI，也可以使用相对 URI。所谓绝对 URI，就是完整形式的 URI，包括 scheme、host:port、path 等。所谓相对 URI，就是省略了 scheme 和 host:port，只有 path 和 query 部 分，是不完整的，但可以从请求上下文里计算得到。

### **重定向状态码**

最常见的重定向状态码就是 301 和 302，另外还有几个不太常见的，例如 303、307、308 等。它们最终的效果都差不多，让浏览器跳转到新的 URI，但语义上有一些细微的差别，使用的时候要特别注意。

- **301**俗称永久重定向(Moved Permanently)，意思是原 URI 已经永久性地不存在了，今后的所有请求都必须改用新的 URI
- **302**俗称临时重定向(Moved Temporarily)，意思是原 URI 处于临时维护状态，新的 URI 是起顶包作用的临时工

301/302 是最常用的重定向状态码，在 3××里剩下的几个还有:

- 303 See Other:类似 302，但要求重定向后的请求改为 GET 方法，访问一个结果页面，避免 POST/PUT 重复操作
- 307 Temporary Redirect:类似 302，但重定向后请求里的方法和实体不允许变动，含义比 302 更明确
- 308 Permanent Redirect:类似 307，不允许重定向后的请求变动，但它是301永久重定向的含义

不过这三个状态码的接受程度较低，有的浏览器和服务器可能不支持，开发时应当慎重，测试确认浏览器的实际效果后才能使用。

### **重定向的应用场景**

理解了重定向的工作原理和状态码的含义，我们就可以**在服务器端拥有主动权**，控制浏览器的行为，不过要怎么利用重定向才好呢?

使用重定向跳转，核心是要理解**重定向**和**永久 / 临时**这两个关键词。

先来看什么时候需要重定向

- 一个最常见的原因就是**资源不可用**，需要用另一个新的 URI 来代替

  至于不可用的原因那就很多了。例如域名变更、服务器变更、网站改版、系统维护，这些都会导致原 URI 指向的资源无法访问，为了避免出现 404，就需要用重定向跳转到新的 URI，继续为网民提供服务。

- 另一个原因就是**避免重复**，让多个网址都跳转到一个 URI，增加访问入口的同时还不会增加额外的工作量

决定要实行重定向后接下来要考虑的就是永久和临时的问题了，也就是选择 301 还是 302。

301 的含义是**永久**的

如果域名、服务器、网站架构发生了大幅度的改变，比如启用了新域名、服务器切换到了新机房、网站目录层次重构， 这些都算是永久性的改变。原来的 URI 已经不能用了， 必须用 301永久重定向，通知浏览器和搜索引擎更新到 新地址，这也是搜索引擎优化(SEO)要考虑的因素之一。

302 的含义是**临时**的

原来的 URI 在将来的某个时间点还会恢复正常，常见的应用场景就是系统维护，把网站重定向到一个通知页面，告诉用户过一会儿再来访问。另一种用法就是服务降级，比如在双十一促销的时候，把订单查询、领积分等不重要的功能入口暂时关闭，保证核心服务能够正常运行。

### **重定向的相关问题**

重定向的用途很多，掌握了重定向，就能够在架设网站时获得更多的灵活性，不过在使用时还需要注意两个问题。

第一个问题是**性能损耗**。很明显，重定向的机制决定了 一个跳转会有两次请求 - 应答，比正常的访问多了一次。

虽然 301/302 报文很小，但大量的跳转对服务器的影响也 是不可忽视的。站内重定向还好说，可以长连接复用，站外 重定向就要开两个连接，如果网络连接质量差，那成本可就 高多了，会严重影响用户的体验。

所以重定向应当适度使用，决不能滥用。

第二个问题是**循环跳转**。如果重定向的策略设置欠考 虑，可能会出现A=>B=>C=>A的无限循环，不停地在 这个链路里转圈圈，后果可想而知。

所以 HTTP 协议特别规定，浏览器必须具有检测循环跳 转的能力，在发现这种情况时应当停止发送请求并给出错误提示

### **小结**

- 重定向是服务器发起的跳转，要求客户端改用新的 URI 重新发送请求，通常会自动进行，用户是无感知的
- 301/302 是最常用的重定向状态码，分别是永久重定向和临时重定向

- 响应头字段 Location 指示了要跳转的 URI，可以用绝对或相对的形式
- 重定向可以把一个 URI 指向另一个 URI，也可以把多URI 指向同一个 URI，用途很多
- 使用重定向时需要当心性能损耗，还要避免出现循环跳转。

## 参考

[透视HTTP协议(罗剑锋)](https://time.geekbang.org/column/intro/100029001)