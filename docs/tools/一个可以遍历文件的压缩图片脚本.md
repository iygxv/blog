---
sidebar: 
 title: ä¸€ä¸ªå¯ä»¥éå†æ–‡ä»¶çš„å‹ç¼©å›¾ç‰‡è„šæœ¬
 step: 1
 isTimeLine: true
title: ä¸€ä¸ªå¯ä»¥éå†æ–‡ä»¶çš„å‹ç¼©å›¾ç‰‡è„šæœ¬
tags:
 - Tools
categories:
 - Tools
---

# ä¸€ä¸ªå¯ä»¥éå†æ–‡ä»¶çš„å‹ç¼©å›¾ç‰‡è„šæœ¬

## ç®€ä»‹
è¿™æ˜¯ä¸€ä¸ªå¯ä»¥éå†æ–‡ä»¶çš„å‹ç¼©å›¾ç‰‡è„šæœ¬, å¯ä»¥è‡ªåŠ¨éå†æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶, å¹¶è‡ªåŠ¨å‹ç¼©å›¾ç‰‡, ä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ã€‚

ä½¿ç”¨çš„æ’ä»¶ï¼š[sharp](https://github.com/lovell/sharp)


## è¯¦ç»†ä»£ç å±•ç¤º
```js
const fs = require('fs');
const path = require('path');
const sharp = require('sharp');

function formatFileSize(size) {
  if (size < 1024) {
    return size + ' B';
  } else if (size < 1024 * 1024) {
    return (size / 1024).toFixed(2) + ' KB';
  } else if (size < 1024 * 1024 * 1024) {
    return (size / (1024 * 1024)).toFixed(2) + ' MB';
  } else {
    return (size / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
  }
}
// åœ¨è¿™é‡Œæ›¿æ¢ä¸ºä½ çš„å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„
const imageDir = './docs';
const originalSizes = []; // ç”¨äºå­˜å‚¨æ‰€æœ‰åŸå§‹å›¾ç‰‡çš„æ–‡ä»¶å¤§å°
const compressedSizes = []; // ç”¨äºå­˜å‚¨æ‰€æœ‰å‹ç¼©åå›¾ç‰‡çš„æ–‡ä»¶å¤§å°

function compressAndReplaceImage(filePath) {
  const originalSize = fs.statSync(filePath).size; // è·å–åŸå§‹å›¾ç‰‡æ–‡ä»¶å¤§å°
  originalSizes.push(originalSize); // å°†åŸå§‹å›¾ç‰‡æ–‡ä»¶å¤§å°å­˜å…¥æ•°ç»„

  return sharp(filePath, {
    animated: true,
    limitInputPixels: false,
  }).png({
    compressionLevel: 9,
    quality: 90 // ä½¿ç”¨è¾¾åˆ°ç»™å®šè´¨é‡æ‰€éœ€çš„æœ€ä½æ•°é‡çš„é¢œè‰²
  }).toBuffer().then(data => {
      fs.writeFileSync(filePath, data); // è¦†ç›–åŸå§‹å›¾ç‰‡

      const compressedSize = fs.statSync(filePath).size; // è·å–å‹ç¼©åçš„å›¾ç‰‡æ–‡ä»¶å¤§å°
      compressedSizes.push(compressedSize); // å°†å‹ç¼©åçš„å›¾ç‰‡æ–‡ä»¶å¤§å°å­˜å…¥æ•°ç»„

      console.log(`${filePath} å‹ç¼©å®Œæˆ`);
    })
    .catch(err => {
      console.error(`å‹ç¼©å¹¶æ›¿æ¢å›¾ç‰‡æ—¶å‘ç”Ÿé”™è¯¯: ${err}`);
    });
}

// é€’å½’æŸ¥æ‰¾æ–‡ä»¶
function findImagesInDir(dir) {
  const files = fs.readdirSync(dir);
  files.forEach(file => {
    const filePath = path.join(dir, file);
    const stat = fs.statSync(filePath);
    if (stat.isDirectory()) {
      findImagesInDir(filePath); // å¦‚æœæ˜¯ç›®å½•ï¼Œåˆ™é€’å½’æŸ¥æ‰¾
    } else {
      if (/\.(jpg|jpeg|png)$/i.test(file)) {
        compressAndReplaceImage(filePath);
      }
    }
  });
}

// å‹ç¼©å›¾ç‰‡å¹¶è®¡ç®—åŸå§‹å›¾ç‰‡æ–‡ä»¶å¤§å°çš„æ€»å’Œ
findImagesInDir(imageDir);

// åœ¨æ‰€æœ‰å›¾ç‰‡å‹ç¼©å®Œæˆåï¼Œè¿›è¡Œç»Ÿè®¡å’Œè¾“å‡º
process.on('exit', () => {
  const totalOriginalSize = originalSizes.reduce((sum, size) => sum + size, 0);
  console.log(`æ‰€æœ‰åŸå§‹å›¾ç‰‡çš„æ–‡ä»¶å¤§å°æ€»å’Œä¸º: ${formatFileSize(totalOriginalSize)}`);

  const totalCompressedSize = compressedSizes.reduce((sum, size) => sum + size, 0);
  console.log(`æ‰€æœ‰å‹ç¼©åå›¾ç‰‡çš„æ–‡ä»¶å¤§å°æ€»å’Œä¸º: ${formatFileSize(totalCompressedSize)}`);

  const totalDifference = totalOriginalSize - totalCompressedSize;
  console.log(`æ‰€æœ‰å›¾ç‰‡å‹ç¼©å®Œæˆï¼Œæ€»çš„æ–‡ä»¶å¤§å°å‡å°‘äº† ${formatFileSize(totalDifference)}`);
});
```

<br/>
<hr />

â­ï¸â­ï¸â­ï¸å¥½å•¦ï¼ï¼ï¼æœ¬æ–‡ç« åˆ°è¿™é‡Œå°±ç»“æŸå•¦ã€‚â­ï¸â­ï¸â­ï¸

âœ¿âœ¿ãƒ½(Â°â–½Â°)ãƒâœ¿

æ’’èŠ± ğŸŒ¸ğŸŒ¸ğŸŒ¸ğŸŒ¸ğŸŒ¸ğŸŒ¸
