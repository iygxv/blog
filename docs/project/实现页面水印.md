---
sidebar: 
 title: å®ç°é¡µé¢æ°´å°
 step: 1
 isTimeLine: true
title: å®ç°é¡µé¢æ°´å°
tags:
 - é¡¹ç›®
categories:
 - é¡¹ç›®
---

# å®ç°é¡µé¢æ°´å°

## ç®€ä»‹
è¿™é‡Œè®°å½•ä¸€ä¸‹é¡µé¢æ°´å°çš„å®ç°æ–¹æ³•ï¼Œç®€å•æ­å»ºä¸€ä¸ª demo é¡¹ç›®ï¼ˆ[é¡¹ç›®åœ°å€](https://github.com/iygxv/watermark-demo)ï¼‰

å…·ä½“çš„å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š
- é€šè¿‡ canvas ç”Ÿæˆæ°´å°ä¿¡æ¯
- å°†ç”Ÿæˆçš„ canvas è½¬æˆ base64
- å°†base64 æ•°æ®ä½œä¸ºèƒŒæ™¯å›¾ç‰‡
- MutationObserver ç›‘å¬ï¼Œé˜²æ­¢ç”¨æˆ·æ‰‹åŠ¨æ›´æ”¹ç§»é™¤

## ç›¸å…³ä»£ç 

ä¸‹é¢ä»£ç æ˜¯å¯¹æ°´å°å°è£…çš„å‡½æ•°ï¼Œåªéœ€è¦è°ƒç”¨å³å¯

```js
function watermark(options = {}) {
  const {
    container = document.body, // å®¹å™¨
    width = '240', // canvaså…ƒç´ å®½
    height = '100', // canvaså…ƒç´ é«˜
    textAlign = 'left', // æ–‡å­—å¯¹é½
    textBaseline = 'bottom', // åŸºå‡†çº¿
    font = '16px Microsoft Yahei', // å­—ä½“å¤§å°åŠæ ·å¼
    fillStyle = '#000', // è‡ªå®šä¹‰æ°´å°çš„é¢œè‰²
    content = 'è¿›åˆ¶å¤–ä¼ ', // æ°´å°å†…å®¹
    globalAlpha = 0.3, // è®¾ç½®å›¾å½¢å’Œå›¾åƒé€æ˜åº¦çš„å€¼
    rotate = 16, // æ–‡å­—æ—‹è½¬è§’åº¦
    zIndex = 1000, // å…ƒç´ å †å é¡ºåº
  } = options

  const canvas = document.createElement('canvas')
  canvas.setAttribute('width', width)
  canvas.setAttribute('height', height)
  const ctx = canvas.getContext('2d') // è·å– canvas2d ä¸Šä¸‹æ–‡
  ctx.globalAlpha = globalAlpha
  ctx.textAlign = textAlign
  ctx.textBaseline = textBaseline
  ctx.font = font
  ctx.fillStyle = fillStyle
  ctx.rotate((Math.PI * rotate) / 180)
  // ctx.rotate(-10 * Math.PI / 140);
  ctx.fillText(content, 50, 50)

  const base64Url = canvas.toDataURL() // è¿”å›ä¸€ä¸ªåŒ…å«å›¾ç‰‡å±•ç¤ºçš„ data URI

  const __wm = document.querySelector('.__wm') // é€‰æ‹©å™¨
  const watermarkDiv = __wm || document.createElement('div')
  const waterMarkStyle = `
    position:absolute;
    top:0px;
    left:0px;
    width:100%;
    height:100%;
    z-index:${zIndex};
    pointer-events:none;
    background-repeat:repeat;
    background-image:url('${base64Url}')`

  watermarkDiv.setAttribute('style', waterMarkStyle)
  watermarkDiv.classList.add('__wm') // ä¸ºå…ƒç´ æ·»åŠ â€œ__wmâ€ç±»å

  container.style.position = 'relative'
  container.appendChild(watermarkDiv) // æ·»åŠ å…ƒç´ 

  // ç›‘å¬åˆ é™¤ é˜²æ­¢ç”¨æˆ·å»æ‰‹åŠ¨åˆ é™¤ï¼Œå¦‚æœæ‰‹åŠ¨åˆ é™¤ ï¼Œåœ¨é‡æ–°æ·»åŠ 
  const MutationObserver = window.MutationObserver || window.WebKitMutationObserver
  // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¿™ä¸ªAPI
  if (MutationObserver) {
    const args = arguments[0]
    const __wm = document.querySelector('.__wm')
    let mo = new MutationObserver(function () {
      // åªåœ¨__wmå…ƒç´ å˜åŠ¨æ‰é‡æ–°è°ƒç”¨
      if ((__wm && __wm.getAttribute('style') !== waterMarkStyle) || !__wm || document.body.style.position !== 'relative') {
        // é¿å…ä¸€ç›´è§¦å‘
        mo.disconnect()
        mo = null
        watermark(args)
      }
    })
    mo.observe(__wm, {
      attributes: true, // è§‚å¯Ÿç›®æ ‡èŠ‚ç‚¹çš„å±æ€§èŠ‚ç‚¹
      subtree: false, // è§‚å¯Ÿç›®æ ‡èŠ‚ç‚¹çš„æ‰€æœ‰åä»£èŠ‚ç‚¹
      childList: true // è§‚å¯Ÿç›®æ ‡èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
    })
  }
}
export default watermark
```

## é¡¹ç›®ä¸­è°ƒç”¨
```vue
<template>
  <div class="hello-world-page">
   <button @click="createWaterMark">ç”Ÿæˆæ°´å°</button>
  </div>
</template>

<script>
import watermark from '@/utils/waterMark'
export default {
  data() {
    return {
    }
  },
  methods: {
   createWaterMark() {
     watermark()
   }
  }
}
</script>

<style lang='scss' scoped>
.hello-world-page {
  width: 100vw;
  height: 100vh;
}
</style>
```

## æ€»ç»“

å…¶å®ç”Ÿæˆæ°´å°çš„åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯å°†æ–‡å­—ç»˜åˆ¶åˆ° canvas ä¸Šï¼Œç„¶åå°† canvas è½¬æˆ base64 æ•°æ®ä½œä¸ºèƒŒæ™¯å›¾ç‰‡ï¼Œè¿™æ ·å°±å®ç°äº†é¡µé¢æ°´å°çš„æ•ˆæœã€‚

å¦å¤–ï¼Œéœ€è¦æ³¨æ„ä½¿ç”¨ `MutationObserver` æ¥ç›‘å¬DOMç»“æ„çš„å˜åŒ–ï¼Œé˜²æ­¢ç”¨æˆ·å¯¹é¡µé¢è¿›è¡Œæ“ä½œï¼Œå¯¼è‡´æ°´å°ç§»é™¤


<br/>
<hr />

â­ï¸â­ï¸â­ï¸å¥½å•¦ï¼ï¼ï¼æœ¬æ–‡ç« åˆ°è¿™é‡Œå°±ç»“æŸå•¦ã€‚â­ï¸â­ï¸â­ï¸

âœ¿âœ¿ãƒ½(Â°â–½Â°)ãƒâœ¿

æ’’èŠ± ğŸŒ¸ğŸŒ¸ğŸŒ¸ğŸŒ¸ğŸŒ¸ğŸŒ¸
